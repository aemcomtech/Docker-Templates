services:
  # --- Main Service ---
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    environment:
      - DOMAIN=${DOMAIN}
      - SIGNUPS_ALLOWED=${SIGNUPS_ALLOWED}
      - WEBSOCKET_ENABLED=true
      # Logging
      - LOG_FILE=/data/vaultwarden.log
      - LOG_LEVEL=warn
    volumes:
      - vw-data:/data
    ports:
      - "${VW_HTTP_PORT}:80"
      - "${VW_WEBSOCKET_PORT}:3012"
    networks:
      ${YOUR_NETWORK_1}:
      ${YOUR_NETWORK_2}:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s

  # --- Backup Sidecar ---
  vw-backup:
    image: ttionya/vaultwarden-backup:latest
    container_name: vw-backup
    restart: unless-stopped
    environment:
      - CRON=${BACKUP_CRON}
      - ZIP_ENABLE=TRUE
      - BACKUP_KEEP_DAYS=${BACKUP_RETENTION_DAYS}
      - TIMEZONE=${TZ}
    volumes:
      # Sources: Must match the main container's volume
      - vw-data:/data
      # Target: Local backup folder
      - ./backups:/backups
      # Optional: Config for Rclone if using cloud sync
      - ./config:/config
    networks:
      ${YOUR_NETWORK_2}:
    depends_on:
      - vaultwarden

volumes:
  vw-data:

networks:
  ${YOUR_NETWORK_1}:
    external: true
  ${YOUR_NETWORK_2}:
    name: ${YOUR_NETWORK_2}
    driver: bridge