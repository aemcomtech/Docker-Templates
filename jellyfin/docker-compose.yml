services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    hostname: jellyfin
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    networks:
      ${YOUR_NETWORK_1}:
      ${YOUR_NETWORK_2}:
    
    # --- Ports ---
    ports:
      - "${JELLYFIN_PORT}:8096"   # Web UI
      - "7359:7359/udp"           # Service discovery
      - "1900:1900/udp"           # DLNA announcements

    # --- Volumes ---
    volumes:
      # Config & Cache
      - ${JELLYFIN_CONFIG_DIR}:/config
      - ${JELLYFIN_CACHE_DIR}:/cache
      - ${JELLYFIN_TRANSCODE_DIR}:/transcode
      
      # Media Libraries
      - ${MEDIA_MOVIES_DIR}:/media/movies
      - ${MEDIA_TV_DIR}:/media/tv
      - ${MEDIA_MUSIC_DIR}:/media/music
      - ${MEDIA_BOOKS_DIR}:/media/books

    # --- Hardware Acceleration ---
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 1G
          devices:
            - driver: nvidia
              # Maps to the specific GPU ID defined in .env
              device_ids: ['${NVIDIA_DEVICE_ID}']
              capabilities: [gpu, utility, compute, video]

    # --- Healthcheck ---
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  ${YOUR_NETWORK_1}:
    name: ${YOUR_NETWORK_1}
    external: true
  ${YOUR_NETWORK_2}:
    name: ${YOUR_NETWORK_2}
    external: true